# Taro Plugin - Refactor to Proper Structure (IN PROGRESS)

**Status:** Partially Complete - ~70% done
**Date:** February 15, 2026

## What Was Done

### Backend Refactor ✅
- [x] Created `plugins/taro/` directory structure
- [x] Created `plugins/taro/src/` with models, repositories, services, routes, events, handlers
- [x] Created `plugins/taro/__init__.py` with TaroPlugin class
- [x] Created `plugins/taro/config.json` and `admin-config.json`
- [x] Created `plugins/taro/migrations/` directory
- [x] Moved `plugins/taro/bin/` to `plugins/taro/src/bin/`
- [x] Updated all imports in src/ files from `src.plugins.taro` → `plugins.taro.src`
- [x] Moved tests to `plugins/taro/tests/` (root level, not in src/)
- [x] Created `plugins/taro/locale/` with en.json
- [x] Updated test imports

### Frontend Refactor ✅
- [x] Created `user/plugins/taro/` directory structure
- [x] Moved `Taro.vue` to `user/plugins/taro/src/`
- [x] Moved components to `user/plugins/taro/src/components/`
- [x] Moved store to `user/plugins/taro/src/stores/`
- [x] Created `user/plugins/taro/index.ts` with plugin definition
- [x] Created `user/plugins/taro/config.json` and `admin-config.json`
- [x] Created `user/plugins/taro/locales/` directory

## What Still Needs To Be Done

### Frontend Import Updates (HIGH PRIORITY)
1. **Update Taro.vue imports:**
   ```typescript
   // OLD
   import { useTaroStore } from '@/stores/taro';
   import CardDisplay from '@/components/taro/CardDisplay.vue';

   // NEW
   import { useTaroStore } from '../plugins/taro/src/stores/taro';
   import CardDisplay from '../plugins/taro/src/components/CardDisplay.vue';
   // OR use path aliases in vite.config.ts
   ```

2. **Update CardDisplay.vue imports:**
   ```typescript
   import type { TaroCard } from '../../../src/stores/taro';
   // OR
   import type { TaroCard } from '../../stores/taro';
   ```

3. **Update SessionHistory.vue and CardDetailModal.vue imports similarly**

### Router Configuration Updates
- **File:** `vbwd-frontend/user/vue/src/router/index.ts`
- **Current:** Route imports from `../views/Taro.vue`
- **Update to:** Import from `../plugins/taro/src/Taro.vue`
  ```typescript
  {
    path: '/dashboard/taro',
    name: 'taro',
    component: () => import('../plugins/taro/src/Taro.vue'),
    meta: { requiresAuth: true }
  }
  ```

### Navigation Updates
- **File:** `vbwd-frontend/user/vue/src/layouts/UserLayout.vue`
- **Status:** Already points to `/dashboard/taro` route - no changes needed if router works

### Store Re-exports
- **File:** `vbwd-frontend/user/vue/src/stores/index.ts`
- **Update:** Point to new location
  ```typescript
  export { useTaroStore } from '../plugins/taro/src/stores/taro';
  export type { TaroSession, TaroCard, ... } from '../plugins/taro/src/stores/taro';
  ```

### Frontend Locale Files
- **Files needed:**
  - `user/plugins/taro/locales/en.json`
  - `user/plugins/taro/locales/de.json` (optional)
- **Format:** Translation keys for Taro UI text
  ```json
  {
    "taro": {
      "title": "Tarot Card Reading",
      "subtitle": "...",
      "dailyLimits": "...",
      ...
    }
  }
  ```

### E2E Tests Relocation
- **Current:** `vbwd-frontend/user/vue/tests/e2e/taro.spec.ts`
- **Options:**
  - Option A: Keep in `tests/e2e/` (simpler, global testing)
  - Option B: Move to `plugins/taro/tests/` (follows plugin pattern)
- **Recommendation:** Keep in global `tests/e2e/` for now

### Backend Migrations
- **Status:** Directory structure created, but migration files need to be created
- **Location:** `vbwd-backend/plugins/taro/migrations/versions/`
- **Files to create:**
  - `20260215_001_create_arcana_table.py`
  - `20260215_002_create_taro_session_and_card_draw_tables.py`
- **Note:** These can be auto-generated by Alembic or manually created

## File Movement Summary

```
BEFORE:
vbwd-backend/src/plugins/taro/          → MOVED TO
vbwd-backend/plugins/taro/

  With internal structure:
  ├── __init__.py (TaroPlugin class)
  ├── config.json
  ├── admin-config.json
  ├── locale/
  ├── migrations/
  ├── src/
  │   ├── models/
  │   ├── repositories/
  │   ├── services/
  │   ├── routes.py
  │   ├── events.py
  │   ├── handlers.py
  │   ├── bin/
  │   │   └── populate_arcanas.py
  │   └── tests/
  └── tests/  (NOT in src/, at root level)


vbwd-frontend/user/vue/src/views/Taro.vue      → MOVED TO
vbwd-frontend/user/plugins/taro/src/Taro.vue

vbwd-frontend/user/vue/src/components/taro/    → MOVED TO
vbwd-frontend/user/plugins/taro/src/components/

vbwd-frontend/user/vue/src/stores/taro.ts      → MOVED TO
vbwd-frontend/user/plugins/taro/src/stores/taro.ts
```

## Testing After Refactor

### Backend
```bash
cd vbwd-backend
make test  # Should pass all tests with new import paths
pytest plugins/taro/tests/ -v  # Run Taro tests
```

### Frontend
```bash
cd vbwd-frontend/user/vue
npm run test  # Unit tests
npm run test:e2e  # E2E tests
```

## Critical Import Changes

### Backend Pattern
```python
# OLD - Don't use
from src.plugins.taro.models import Arcana

# NEW - Use this
from plugins.taro.src.models import Arcana
```

### Frontend Pattern
```typescript
// OLD - Don't use
import { useTaroStore } from '@/stores/taro';

// NEW - Use this (or via alias)
import { useTaroStore } from '@/plugins/taro/src/stores/taro';
```

## Next Steps (In Order)

1. ✅ Backend structure refactored
2. ✅ Frontend directory structure created
3. ⏳ **Update all frontend imports in Taro.vue**
4. ⏳ **Update router configuration**
5. ⏳ **Update store re-exports**
6. ⏳ **Create frontend locale files**
7. ⏳ **Create backend migration files**
8. ⏳ **Run tests to verify everything works**
9. ⏳ **Clean up empty directories** (src/components/taro/, src/views/Taro*)
10. ⏳ **Verify plugin loads correctly**

## Verification Checklist

After completing the refactor:
- [ ] `npm run dev` starts without errors
- [ ] Can navigate to `/dashboard/taro`
- [ ] Taro page loads and functions
- [ ] Store mutations work correctly
- [ ] API calls work (`/api/v1/taro/*`)
- [ ] E2E tests pass: `npm run test:e2e -- taro`
- [ ] Backend tests pass: `make test`
- [ ] No import errors in console
- [ ] No TypeScript errors: `tsc --noEmit`
- [ ] Plugin follows chat plugin structure

## Notes

- The user app (vbwd-frontend/user) doesn't use the full plugin system yet - it's still a traditional Vue app
- Files are organized in `plugins/` for consistency with backend structure
- The router and navigation still import components directly
- The store might need to be re-exported from `stores/index.ts` for consistency

## References

- **Chat Plugin Example:** `vbwd-backend/plugins/chat/`
- **Chat Frontend Plugin:** `vbwd-frontend/user/plugins/chat/`
- **Stripe Plugin:** `vbwd-backend/plugins/stripe/` (payment provider example)

---

**Last Updated:** February 15, 2026
**Status:** Ready for completion - all heavy lifting done, just import updates remaining

