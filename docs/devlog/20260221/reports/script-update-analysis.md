# Installation Scripts Update - Detailed Analysis

**Date**: 2026-02-21
**Subject**: Mapping old monorepo structure to new independent repos
**Status**: Ready for discussion

---

## Current Scripts Overview

### dev-install-ce.sh (Community Edition)
**Purpose**: Full stack installation for local development
- Clones vbwd-backend and vbwd-frontend
- Starts Docker containers
- Runs database migrations
- Runs backend tests
- Services available on localhost

**Key Variables**:
```bash
BACKEND_REPO="https://github.com/dantweb/vbwd-backend.git"
FRONTEND_REPO="https://github.com/dantweb/vbwd-frontend.git"  # ❌ OLD
BACKEND_DIR="$WORKSPACE_DIR/vbwd-backend"
FRONTEND_DIR="$WORKSPACE_DIR/vbwd-frontend"  # ❌ OLD
```

### dev-install-taro.sh (Taro Plugin)
**Purpose**: Install CE + populate Taro card database
- Calls dev-install-ce.sh
- Runs Taro database population script

**Key Line**:
```bash
TARO_POPULATE_SCRIPT="$WORKSPACE_DIR/vbwd-backend/plugins/taro/bin/populate-db.sh"
```

---

## Structure Mapping

### Old Structure (Monorepo)
```
vbwd-sdk/
├── vbwd-backend/
│   ├── docker-compose.yml
│   └── plugins/taro/...
├── vbwd-frontend/
│   ├── user/vue/
│   │   ├── docker-compose.yml
│   │   └── package.json
│   ├── admin/vue/
│   │   ├── docker-compose.yml
│   │   └── package.json
│   └── core/
│       └── package.json
└── recipes/
    ├── dev-install-ce.sh
    └── dev-install-taro.sh
```

### New Structure (Independent Repos)
```
vbwd-sdk/
├── vbwd-backend/              (unchanged)
│   ├── docker-compose.yml
│   └── plugins/taro/...
├── vbwd-fe-core/              (NEW: separate repo)
│   ├── docker-compose.yaml
│   ├── package.json
│   └── dist/                  (generated by build)
├── vbwd-fe-user/              (NEW: separate repo)
│   ├── docker-compose.yaml
│   ├── package.json
│   ├── vbwd-fe-core/          (git submodule)
│   └── node_modules/
├── vbwd-fe-admin/             (NEW: separate repo)
│   ├── docker-compose.yaml
│   ├── package.json
│   ├── vbwd-fe-core/          (git submodule)
│   └── node_modules/
└── recipes/
    ├── dev-install-ce.sh       (NEEDS UPDATE)
    └── dev-install-taro.sh     (NEEDS UPDATE)
```

---

## Detailed Changes Required

### 1. dev-install-ce.sh Changes

#### Problem Areas

| Line | Problem | Old | New |
|------|---------|-----|-----|
| 27 | Frontend repo URL | Single vbwd-frontend | Three separate repos |
| 29 | Frontend directory | Single dir | Three separate dirs |
| 136-147 | Clone frontend | Clone one repo | Clone three repos with submodules |
| 254-267 | Frontend docker-compose | Monorepo structure | Each repo has own docker-compose |

#### New Logic Flow

```bash
# BEFORE: Clone single frontend
git clone https://github.com/dantweb/vbwd-frontend.git vbwd-frontend

# AFTER: Clone three frontend repos in sequence
# 1. Core library first (no dependencies)
git clone https://github.com/dantweb/vbwd-fe-core.git vbwd-fe-core
cd vbwd-fe-core && npm install && npm run build && cd ..

# 2. User app with submodule
git clone --recurse-submodules https://github.com/dantweb/vbwd-fe-user.git vbwd-fe-user
cd vbwd-fe-user && npm install && cd ..

# 3. Admin app with submodule
git clone --recurse-submodules https://github.com/dantweb/vbwd-fe-admin.git vbwd-fe-admin
cd vbwd-fe-admin && npm install && cd ..
```

#### Service URLs Update

Old references to single frontend:
```bash
# OLD
echo "Frontend:    http://localhost:8080"
```

New multi-app setup:
```bash
# NEW
echo "Frontend (User app):  http://localhost:8080"
echo "Frontend (Admin app): http://localhost:8081"
echo "Frontend (Core lib):  Published as npm package"
```

### 2. dev-install-taro.sh Changes

#### Minimal Changes Needed

The taro script is simpler - it just:
1. Calls dev-install-ce.sh (which will handle new structure)
2. Runs taro database population

**Only change**: Path references
```bash
# OLD (implied from frontend path)
cd $WORKSPACE_DIR/vbwd-frontend && npm run dev

# NEW (explicit - user app)
cd $WORKSPACE_DIR/vbwd-fe-user && npm run dev
```

**Note**: Taro is a plugin in vbwd-backend, not affected by frontend split.

---

## Implementation Questions

### Question 1: Docker Compose Strategy
**Current**: Each app has its own docker-compose.yaml
**Options**:
- Option A: Keep individual docker-compose (current)
  - Pros: Isolated environments
  - Cons: Running 3+ docker-compose up commands
  - Best for: Independent repo development

- Option B: Create composite docker-compose at repo root
  - Pros: Single `docker-compose up` command
  - Cons: Couples repos together
  - Best for: Monolithic local dev

**Recommendation**: Keep Option A (individual per app) - aligns with independent repo philosophy

### Question 2: Frontend Port Assignment
**Current**: All frontend on port 8080
**Problem**: Can't run user and admin apps simultaneously

**Options**:
- Option A: User on 8080, Admin on 8081 (separate instances)
- Option B: Add env var for port configuration
- Option C: Proxy setup with nginx

**Recommendation**: Option A (simplest, most common)

### Question 3: Build Order
**Critical**: vbwd-fe-core must build before user/admin npm install

**Current approach**:
```bash
cd vbwd-fe-core && npm install && npm run build && cd ..
cd vbwd-fe-user && npm install
cd vbwd-fe-admin && npm install
```

**Validate**: Is this the right order? Submodules will have dist/ from GitHub checkout?

**Answer**: ✅ Yes - submodules clone source code, npm install creates symlinks, dist/ must exist for TypeScript

---

## Script Size Comparison

### Current dev-install-ce.sh
- **Lines**: 288
- **Sections**: 5 main steps + helpers
- **Complexity**: High (Docker integration, health checks)

### Proposed dev-install-ce.sh
- **Lines**: ~320 (estimated +30-40 for 3 repos)
- **Complexity**: Similar (still Docker, more repo cloning)

### Implementation Impact
- Minimal code increase
- Similar complexity
- More readable with clear repo setup section

---

## Testing Plan

### Local Testing Steps
1. **Fresh directory test**
   ```bash
   mkdir /tmp/vbwd-test
   cd /tmp/vbwd-test
   bash /path/to/updated/dev-install-ce.sh
   ```

2. **Verify all repos cloned**
   ```bash
   ls -la vbwd-backend vbwd-fe-core vbwd-fe-user vbwd-fe-admin
   ```

3. **Check submodules initialized**
   ```bash
   cd vbwd-fe-user && git submodule status
   cd ../vbwd-fe-admin && git submodule status
   ```

4. **Verify builds**
   ```bash
   # Each repo should have dist/ or node_modules/
   ls vbwd-fe-core/dist/
   ls vbwd-fe-user/node_modules/vbwd-view-component
   ```

5. **Services check**
   ```bash
   # Backend should respond
   curl http://localhost:5000/health

   # Frontend apps should be ready
   curl http://localhost:8080
   curl http://localhost:8081
   ```

---

## Documentation Updates Needed

After script updates, update:
1. **README.md** - Quick start section
2. **docs/dev-setup.md** - Installation guide
3. **docs/ARCHITECTURE.md** - New repo structure
4. **CLAUDE.md** - Development commands

---

## Risk Assessment

### Low Risk Areas
- ✅ Repo cloning (git handles this)
- ✅ npm install (standard operation)
- ✅ Docker startup (unchanged for backend)

### Medium Risk Areas
- ⚠️ Build order (vbwd-fe-core must complete first)
- ⚠️ Submodule initialization (needs `--recurse-submodules`)
- ⚠️ Port conflicts (8080, 8081 must be free)

### Mitigation
- Add clear comments explaining build order
- Add validation: check if ports are available
- Add error messages: what to do if submodule fails

---

## Next Steps (For Discussion)

1. **Architecture Decision**: Docker setup - individual or composite?
2. **Port Assignment**: Confirm 8080/8081 for user/admin?
3. **Error Handling**: What to do if submodule checkout fails?
4. **Testing Environment**: CI/local behavior - same or different?
5. **Documentation**: Update scope - just README or comprehensive?

---

## Summary

| Aspect | Impact | Status |
|--------|--------|--------|
| dev-install-ce.sh | Moderate update (~30-40 lines) | Ready to discuss |
| dev-install-taro.sh | Minimal update (path references) | Ready to update |
| Testing | Need fresh environment test | Outlined in plan |
| Documentation | Need updates | Scoped |
| Risk | Medium (submodules, build order) | Mitigated |

**Ready to proceed with implementation once questions are answered.**

